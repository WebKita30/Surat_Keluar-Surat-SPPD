<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Surat Keluar - SMPN 3 Purwadadi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f6f9;
        margin: 0;
      }

      /* HEADER KOP */
      .header-kop {
        background: #1e3c72;
        color: white;
        padding: 15px;
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 10px;
      }

      .header-kop img {
        height: 70px;
        max-width: 100%;
        object-fit: contain;
      }

      .header-kop .judul {
        text-align: center;
      }

      .header-kop h2 {
        margin: 0;
        font-size: 22px;
      }
      .header-kop p {
        margin: 0;
        font-size: 14px;
      }

      .container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      form,
      .rekap {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      input,
      select {
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        width: 100%;
        box-sizing: border-box;
      }

      /* BUTTON STYLE */
      button,
      .btn-sppd {
        padding: 10px 18px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        gap: 8px;
      }

      .btn-save {
        background: #28a745;
        color: white;
      }
      .btn-pdf {
        background: #dc3545;
        color: white;
      }
      .btn-edit {
        background: #ffc107;
        color: black;
      }
      .btn-delete {
        background: #6c757d;
        color: white;
      }
      .btn-sppd {
        background: #007bff;
        color: white;
      }
      .btn-print {
        background: #17a2b8;
        color: white;
      }

      .action-bar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 15px;
      }

      /* TABEL RESPONSIVE (UNTUK TAMPILAN LAYAR) */
      .table-responsive {
        width: 100%;
        overflow-x: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 900px; /* Minimal lebar agar kolom tidak dempet di layar */
      }

      th,
      td {
        border: 1px solid #000;
        padding: 8px 4px;
        font-size: 12px;
        text-align: center;
        word-wrap: break-word;
      }

      th {
        background: #f2f2f2;
      }

      /* ==========================================
         PENGATURAN CETAK (PRINT FIX)
         ========================================== */
      @media print {
        @page {
          size: 330mm 215mm landscape; /* Kertas F4 Landscape */
          margin: 10mm;
        }

        /* Sembunyikan elemen yang tidak perlu diprint */
        .header-kop,
        #formSurat,
        .rekap h3,
        .action-bar,
        button,
        .btn-sppd {
          display: none !important;
        }

        body {
          background: white;
        }
        .container {
          padding: 0;
          width: 100%;
          max-width: 100%;
        }
        .rekap {
          box-shadow: none;
          padding: 0;
          margin: 0;
        }

        /* Supaya tabel tidak terpotong ke samping */
        .table-responsive {
          overflow: visible !important;
          border: none !important;
        }

        table {
          width: 100% !important;
          min-width: 100% !important; /* Memaksa tabel mengikuti lebar kertas */
          table-layout: fixed; /* Penting: membagi kolom secara proporsional */
        }

        th,
        td {
          font-size: 9pt; /* Ukuran font lebih kecil agar muat */
          border: 1px solid black !important;
        }

        /* Atur lebar kolom agar No dan Tujuan tidak terbuang */
        th:nth-child(1) {
          width: 30px;
        } /* Kolom No */
        th:nth-child(2) {
          width: 150px;
        } /* Kolom Tujuan */
        th:nth-child(3) {
          width: 120px;
        } /* Kolom Nomor Surat */
      }
    </style>
  </head>

  <body>
    <header class="header-kop">
      <img src="logo/subang.png" alt="Logo Subang" />
      <div class="judul">
        <h2>SURAT KELUAR</h2>
        <p>SMP NEGERI 3 PURWADADI<br />KABUPATEN SUBANG</p>
      </div>
      <img src="logo/smpn3pwd.png" alt="Logo SMP" />
    </header>

    <div class="container">
      <form id="formSurat">
        <h3>Input Surat Keluar</h3>
        <div class="form-grid">
          <input type="number" id="no" placeholder="No Urut" required />
          <input
            type="text"
            id="tujuan"
            placeholder="Nama & Alamat Tujuan"
            required
          />
          <input type="text" id="nomor" placeholder="Nomor Surat" required />
          <input type="date" id="tanggal" required />
          <input type="text" id="perihal" placeholder="Perihal" />
          <input type="text" id="lampiran" placeholder="Lampiran" />
          <input type="text" id="petunjuk" placeholder="Nomor Petunjuk" />
          <input type="text" id="keterangan" placeholder="Keterangan" />
        </div>
        <br />
        <button type="submit" class="btn-save">üíæ Simpan Data</button>
      </form>

      <div class="rekap">
        <h3>Kontrol Rekapitulasi</h3>
        <div class="action-bar">
          <label>Bulan:</label>
          <select id="bulan" style="width: 150px"></select>
          <label>Tahun:</label>
          <select id="tahun" style="width: 100px"></select>

          <div
            style="width: 100%; border-bottom: 1px solid #eee; margin: 10px 0"
          ></div>

          <select id="pilihData">
            <option value="">-- Pilih Data untuk Edit/Hapus --</option>
          </select>

          <button class="btn-edit" onclick="editData()">‚úèÔ∏è Edit</button>
          <button class="btn-delete" onclick="hapusData()">üóëÔ∏è Hapus</button>
          <button class="btn-pdf" onclick="downloadPDF()">üìÑ PDF (F4)</button>
          <button class="btn-print" onclick="window.print()">üñ®Ô∏è Cetak</button>
          <a href="sppd.html" class="btn-sppd">üìù Buat SPPD</a>
        </div>
      </div>

      <div id="areaCetak">
        <div id="innerCetak" style="padding: 10px">
          <h2 style="text-align: center; margin-bottom: 5px">
            REKAP SURAT KELUAR
          </h2>
          <h4
            style="text-align: center; margin-top: 0; font-weight: normal"
            id="judulRekap"
          ></h4>

          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th style="width: 40px">No</th>
                  <th>Tujuan</th>
                  <th>Nomor Surat</th>
                  <th style="width: 90px">Tanggal</th>
                  <th>Perihal</th>
                  <th>Lampiran</th>
                  <th>Petunjuk</th>
                  <th>Ket</th>
                </tr>
              </thead>
              <tbody id="dataSurat"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let data = JSON.parse(localStorage.getItem("suratKeluar")) || [];
      let editIndex = null;

      function render() {
        dataSurat.innerHTML = "";
        pilihData.innerHTML =
          '<option value="">-- Pilih Data untuk Edit/Hapus --</option>';
        data.sort((a, b) => a.no - b.no);
        data.forEach((d, i) => {
          dataSurat.innerHTML += `
            <tr>
              <td>${d.no}</td>
              <td style="text-align: left;">${d.tujuan}</td>
              <td>${d.nomor}</td>
              <td>${d.tanggal}</td>
              <td style="text-align: left;">${d.perihal}</td>
              <td>${d.lampiran || "-"}</td>
              <td>${d.petunjuk || "-"}</td>
              <td>${d.keterangan || "-"}</td>
            </tr>`;
          pilihData.innerHTML += `<option value="${i}">${d.no}. ${d.nomor} - ${d.tujuan}</option>`;
        });
        isiFilter();
      }

      formSurat.onsubmit = (e) => {
        e.preventDefault();
        const surat = {
          no: document.getElementById("no").value,
          tujuan: document.getElementById("tujuan").value,
          nomor: document.getElementById("nomor").value,
          tanggal: document.getElementById("tanggal").value,
          perihal: document.getElementById("perihal").value,
          lampiran: document.getElementById("lampiran").value,
          petunjuk: document.getElementById("petunjuk").value,
          keterangan: document.getElementById("keterangan").value,
        };
        if (editIndex === null) {
          data.push(surat);
        } else {
          data[editIndex] = surat;
          editIndex = null;
        }
        localStorage.setItem("suratKeluar", JSON.stringify(data));
        e.target.reset();
        render();
        alert("Data berhasil disimpan!");
      };

      function editData() {
        let val = document.getElementById("pilihData").value;
        if (val === "") return alert("Pilih data yang ingin diedit");
        editIndex = val;
        let d = data[editIndex];
        document.getElementById("no").value = d.no;
        document.getElementById("tujuan").value = d.tujuan;
        document.getElementById("nomor").value = d.nomor;
        document.getElementById("tanggal").value = d.tanggal;
        document.getElementById("perihal").value = d.perihal;
        document.getElementById("lampiran").value = d.lampiran;
        document.getElementById("petunjuk").value = d.petunjuk;
        document.getElementById("keterangan").value = d.keterangan;
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function hapusData() {
        let val = document.getElementById("pilihData").value;
        if (val === "") return alert("Pilih data yang ingin dihapus");
        if (confirm("Hapus data surat ini?")) {
          data.splice(val, 1);
          localStorage.setItem("suratKeluar", JSON.stringify(data));
          render();
        }
      }

      function isiFilter() {
        let bs = new Set(),
          ts = new Set();
        data.forEach((d) => {
          let t = new Date(d.tanggal);
          if (!isNaN(t)) {
            bs.add(t.getMonth());
            ts.add(t.getFullYear());
          }
        });
        if (ts.size === 0) ts.add(new Date().getFullYear());
        if (bs.size === 0) bs.add(new Date().getMonth());
        bulan.innerHTML = "";
        [...bs]
          .sort((a, b) => a - b)
          .forEach((b) => {
            bulan.innerHTML += `<option value="${b}">${new Date(0, b).toLocaleString("id", { month: "long" })}</option>`;
          });
        tahun.innerHTML = "";
        [...ts]
          .sort((a, b) => a - b)
          .forEach((t) => {
            tahun.innerHTML += `<option value="${t}">${t}</option>`;
          });
      }

      async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("l", "mm", [330, 215]); // Ukuran F4 Landscape
        const area = document.getElementById("areaCetak");
        const b = bulan.value;
        const t = tahun.value;

        let filterData = data.filter((d) => {
          let dt = new Date(d.tanggal);
          return dt.getMonth() == b && dt.getFullYear() == t;
        });

        if (filterData.length === 0)
          return alert("Tidak ada data di bulan/tahun ini");

        judulRekap.innerText = `Periode: ${new Date(0, b).toLocaleString("id", { month: "long" })} ${t}`;

        // Clone area cetak agar tidak merusak tampilan asli
        const originalStyle = area.style.cssText;
        area.style.width = "1200px"; // Lebar tetap untuk canvas

        const canvas = await html2canvas(area, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL("image/png");
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const margin = 10;
        const widthTersedia = pdfWidth - margin * 2;
        const imgHeight = (canvas.height * widthTersedia) / canvas.width;

        pdf.addImage(imgData, "PNG", margin, margin, widthTersedia, imgHeight);
        pdf.save(
          `Rekap_Surat_${new Date(0, b).toLocaleString("id", { month: "short" })}_${t}.pdf`,
        );

        area.style.cssText = originalStyle;
      }

      render();
    </script>
  </body>
</html>
